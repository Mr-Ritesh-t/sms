
/**
 * Core Philosophy: This ruleset enforces a security model with a clear separation
 * between private user data and shared application data. It prioritizes strict
 * authorization while allowing flexibility in data structure for rapid prototyping.
 * User-specific data is governed by a strict ownership model, while general
 * school-related data is readable by any authenticated user. Sensitive data like
 * grades is locked down by default pending a more detailed authorization schema.
 *
 * Data Structure: The database is organized into several top-level collections:
 * - /users/{userId}: Stores private user profile information, including roles.
 * - /students/{studentId}: A directory of all students in the system.
 * - /teachers/{teacherId}: A directory of all teachers in the system.
 * - /courses/{courseId}: A catalog of all available courses.
 * - /grades/{gradeId}: Contains sensitive grade information for students.
 *
 * Key Security Decisions:
 * - Default Deny: All paths are closed by default. Access is granted explicitly.
 * - Role-Based Writes: Write access to core data collections (students, teachers, courses)
 *   is restricted to users with an 'admin' role, defined in their /users/{userId} document.
 * - Prototyping-Friendly Reads: To support UI development, any authenticated user can
 *   currently read the main data collections. This should be tightened in the future.
 * - Sensitive Data Lockdown: The /grades collection is completely locked. The
 *   current data model does not contain the necessary information (e.g., a link
 *   between a student and a user's auth ID) to write secure authorization rules.
 */
rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    // Helper functions for reusable logic
    
    /**
     * Checks if the user is authenticated.
     */
    function isSignedIn() {
      return request.auth != null;
    }
    
    /**
     * Checks if the currently authenticated user's ID matches the provided userId.
     * This is the foundation of the user-ownership model.
     */
    function isOwner(userId) {
      return isSignedIn() && request.auth.uid == userId;
    }

    /**
     * Checks if the authenticated user has the 'admin' role.
     * It reads the user's role from their profile document in the /users collection.
     * IMPORTANT: This requires that a 'users/{userId}' document exists for the user.
     */
    function isAdmin() {
      return isSignedIn() && get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'admin';
    }

    /**
     * @description
     *   Manages user profile data. Each user has a document in this collection,
     *   and only that specific user can access or modify their own document.
     *   Listing all users is explicitly forbidden to protect privacy.
     * @path /users/{userId}
     */
    match /users/{userId} {
      allow read, write: if isOwner(userId);
      allow list: if false; // Prevent user enumeration
    }

    /**
     * @description
     *   Stores student profiles. Any authenticated user can read the list of
     *   students, but only admins can create, update, or delete them.
     * @path /students/{studentId}
     */
    match /students/{studentId} {
      allow get, list: if isSignedIn();
      allow write: if isAdmin(); // create, update, delete
    }

    /**
     * @description
     *   Stores teacher profiles. Access rules mirror the /students collection.
     *   Any authenticated user can view teachers, but only admins can modify them.
     * @path /teachers/{teacherId}
     */
    match /teachers/{teacherId} {
      allow get, list: if isSignedIn();
      allow write: if isAdmin(); // create, update, delete
    }

    /**
* @description
* Stores course information. All authenticated users can read the course
* catalog, but only admins can create, update, or delete courses.
* @path /courses/{courseId}
*/
    match /courses/{courseId} {
      allow get, list: if isSignedIn();
      allow write: if isAdmin();
    }


    /**
     * @description
     *   Stores course enrollment information, linking students to courses.
     *   Any authenticated user can read this data to determine who is in
     *   which course. Write access is restricted to admins.
     * @path /enrollments/{enrollmentId}
     */
    match /enrollments/{enrollmentId} {
        allow get, list: if isSignedIn();
        allow write: if isAdmin();
    }
    
    /**
     * @description
     *   Stores fee structure definitions. Any authenticated user can read these
     *   to display fee information, but only admins can create or modify them.
     * @path /feeStructures/{feeId}
     */
    match /feeStructures/{feeId} {
        allow get, list: if isSignedIn();
        allow write: if isAdmin();
    }

    /**
     * @description
     *   Stores the fee status for each student. Read access is allowed for any
     *   signed-in user. Write access is restricted to admins.
     * @path /studentFees/{studentFeeId}
     */
    match /studentFees/{studentFeeId} {
        allow get, list: if isSignedIn();
        allow write: if isAdmin();
    }


    /**
     * @description
     *   Stores sensitive grade information.
     *   TODO: Restrict write access to only the teacher assigned to the course.
     *   This requires denormalizing the teacher's user ID onto the course document.
     * @path /grades/{gradeId}
     */
    match /grades/{gradeId} {
      allow read: if isSignedIn();
      // For now, allow any signed-in user to write. This should be locked down.
      // Example of a secure rule:
      // allow write: if get(/databases/$(database)/documents/courses/$(request.resource.data.courseId)).data.teacherAuthId == request.auth.uid;
      allow write: if isSignedIn();
    }
  }
}
